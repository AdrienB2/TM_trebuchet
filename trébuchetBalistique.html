<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Trébuchet 2D</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="css.css">
	</head>
	<body>
		<h1>Visualisation du lancé d'un trébuchet en 2D</h1>
		<h2>Données:</h2>
		<form>
			<label class="donner">Inclinaison [DEG]:</label>
			<input type="number" id="incl" name="incl" class="inp" value="45"><br>
			<label class="donner">Coefficient de trainée de la balle:</label>
			<input type="number" id="cf" name="cf" value=0.5 class="inp"><br>
			<label class="donner">Masse volumique du fluide entourant la balle [kg par m3]:</label>
			<input type="number" id="p" name="p" class="inp" value=1.292><br>
			<label class=donner>Rayon de la balle [m]:</label>
			<input type="number" id="r" name="r" class="inp" value=0.05><br>
			<label class="donner">Vitesse [m/s]:</label>
			<input type="number" id="v" name="v" class="inp" value=10><br>
			<label class="donner">Accélération gravitationnelle [m/s2]: </label>
			<input type="number" id="g" name="g" class="inp" value=9.81><br>
			<label class="donner">Masse de la balle [kg]: </label>
			<input type="number" id="m" name="m" class="inp" value=0.1><br>
			<label class="donner">X initial [m]: </label>
			<input type="number" id="bx_sup" name="bx_sup" class="inp" value=0><br>
			<label class="donner">Y initial [m]: </label>
			<input type="number" id="by_sup" name="by_sup" class="inp" value=0><br>
			<label class="donner">Pas de temps simulé [s]: </label>
			<input type="number" id="d" name="d" class="inp" value=1e-2><br>
			<label class="donner">Inclinaison du vent [DEG]:</label>
			<input type="number" id="ivent" name="ivent" class="inp" value=0><br>
			<label class="donner">Vitesse du vent [m/s]:</label>
			<input type="number" id="vvent" name="vvent" class="inp" value=0><br>
			<label class="donner">Vitesse angulaire [DEG/s]</label>
			<input type="number" id="w" name="vitesse_angulaire" class="inp" value=0><br>
			<label class="donner">Ralenti:</label>
			<input type="number" id="ralenti" name="ralenti" class="inp" value=1>
		</form>
		<h2 id="calc"></h2>
		<! formulaire des calculs>
		<form>
			<label class="donner" id="A"></label><br>
			<label class="donner" id="V"></label><br>
			<label class="donner" id="mv"></label><br>
			<label class="donner" id="vx"></label><br>
			<label class="donner" id="vy"></label><br>
			<label class="donner" id="xmax"></label><br>
			<label class="donner" id="ymax"></label><br>
			<label class="donner" id="t"></label><br>
			<label class="donner" id="dn"></label>
		</form><br>
		<h2 id="tvaleurs"></h2>
		<! formulaire des valeurs en temps réel>
		<form>
			<label class="donner" id="vf"></label><br>
			<label class="donner" id="inclf"></label><br>
			<label class="donner" id="xf"></label><br>
			<label class="donner" id="yf"></label><br>
			<label class="donner" id="tr"></label><br>
			<label class="donner" id="dnr"></label>
		</form>
			<canvas id="MyCanvas" width=600 height=338></canvas><br>
			<button type="button" onclick="Validation();" id="launchcalcul">Calculer</button>
			<button type="button" onclick="Lancer(0);" id="launchbutton">Lancer</button>
			<button type="button" onclick="Vider();" id="vide">Clear</button>
			<button type="button" onclick="Stop();" id="arret">Stop</button>
			<button type="button" onclick="BigStop();" id="grdarret">Arrêt définitif du tracé</button>
 		<script>
			const pi = Math.PI;
			var can = document.getElementById("MyCanvas");
			var candraw = can.getContext("2d");
			var incl = document.getElementById("incl").value;
			var cf = document.getElementById("cf").value;
			var p = document.getElementById("p").value;
			var r = document.getElementById("r").value;
			var v = document.getElementById("v").value;
			var g = document.getElementById("g").value;
			var d = document.getElementById("d").value;
			var m = document.getElementById("m").value;
			var w = document.getElementById("w").value;
			var vvent = document.getElementById("vvent").value;
			var ivent = document.getElementById("ivent").value;
			var bx_sup = parseFloat(document.getElementById("bx_sup").value);
			var by_sup = parseFloat(document.getElementById("by_sup").value);
			var ralenti = document.getElementById("ralenti").value;
			var listex = [bx_sup];
			var listey = [by_sup];
			var listev = [v];
			var listeincl = [incl];
			var x = bx_sup;
			var y = by_sup;
			//candraw.globalCompositeOperation= "hard-light";
			var xmax = 0;
			var ymax = 0;
			var c = 0;
			document.getElementById("launchbutton").disabled = true;
			document.getElementById("arret").disabled = true;
			document.getElementById("grdarret").disabled = true;
			function arrondi(a,b){
				return (Math.floor(a/b))*b;
			};
			function miax(liste){	/*fonction pour calculer le max et le min d'une liste*/
				let min = liste[0], max=liste[0]
				for(let i=1;i<liste.length;i++){
					if(liste[i]>max){
						max=liste[i];
					}else if(liste[i]<min){
						min=liste[i];
					};
				};
				return [max, min]
			};
			function inc(vx,v){
				if(vx>=0){
					return Math.atan(vy/vx)/pi*180
				}else{
					return 180+Math.atan(vy/vx)/pi*180
				};
			};
			function px(x,cx){
				return cx*x
			};
			function py(y,cy){
				return can.height-y*cy
			};
			function ft(v){
				return cf*p*A*v**2/2
			};
			function fm(v){
				return 0.5*pi*p*r**3*w/180*pi*v
			};
			function fA(V){
				return p*V*g
			};
			function Validation(){
				document.getElementById("launchcalcul").disabled = true;
				document.getElementById("calc").innerHTML = "Calculs:"
				incl = document.getElementById("incl").value;
				cf = document.getElementById("cf").value;
				p = document.getElementById("p").value;
				r = document.getElementById("r").value;
				v = document.getElementById("v").value;
				g = document.getElementById("g").value;
				d = document.getElementById("d").value;
				m = document.getElementById("m").value;
				w = document.getElementById("w").value;
				vvent = document.getElementById("vvent").value;
				ivent = document.getElementById("ivent").value;
				bx_sup = parseFloat(document.getElementById("bx_sup").value);
				by_sup = parseFloat(document.getElementById("by_sup").value);
				ralenti = document.getElementById("ralenti").value;
				listex = [bx_sup];
				listey = [by_sup];
				listev = [v];
				listeincl = [incl];
				x = bx_sup;
				y = by_sup;
				A = pi*r**2;
				V = 4/3*pi*r**3;
				vx = v*Math.cos(incl/180*pi);
				vy = v*Math.sin(incl/180*pi);
				document.getElementById("A").innerHTML = "Aire de la section efficace : "+ A + " [m2]";
				document.getElementById("V").innerHTML = "Volume de la balle : " + V + " [m3]";
				document.getElementById("mv").innerHTML = "Masse volumique de la balle : "+(m/V)+" [kg/m3]";
				document.getElementById("vx").innerHTML = "Vitesse en x : " + vx + " [m/s]";
				document.getElementById("vy").innerHTML = "Vitesse en y : " + vy + " [m/s]";
				vx = vx - vvent*Math.cos(ivent*pi/180)
				vy = vy - vvent*Math.sin(ivent*pi/180)
				let debut = performance.now();
				while(y>=0){
					ax=(-ft(v)*Math.cos(incl/180*pi)+fm(v)*Math.sin(incl/180*pi)+fA(V))/m;
					ay=(-ft(v)*Math.sin(incl/180*pi)-m*g-fm(v)*Math.cos(incl/180*pi))/m;
					x += 1/2*ax*d**2 + vx*d;
					listex.push(x);
					y += 1/2*ay*d**2 + vy*d;
					listey.push(y);
					vx += ax*d;
					vy += ay*d;
					v = (vx**2+vy**2)**0.5;
					listev.push(v);
					incl = inc(vx,vy);
					listeincl.push(incl);
				};
				if(xmax == 0 && ymax == 0){
					if(miax(listex)[1]<bx_sup){
						xmax = bx_sup;
					};
					xmax=Math.abs(miax(listex)[0]);
					ymax=Math.abs(miax(listey)[0]);
				};
				var cx = can.width/(xmax);
				var cy = can.height/(ymax);
				if(cx <= cy){
					c = cx
				}else if(cx > cy){
					c = cy
				};
				c = c/(1+0.1); /*0.1 est un coefficient qui fait diminuer la taille dans le canvas pour qu'elle soit plus visible*/
				let fin = performance.now();
				console.log("Temps de calculs: "+(fin-debut)/1000+" [s]")
				document.getElementById("xmax").innerHTML = "Xmax : "+xmax+" [m]";
				document.getElementById("ymax").innerHTML = "Ymax : "+ymax+" [m]";
				document.getElementById("dn").innerHTML = "Nombre de pas : "+(listex.length-1);
				document.getElementById("t").innerHTML = "Durée de vol : " + (listex.length-1)*d+" [s]";
				document.getElementById("launchbutton").disabled = false;
				document.getElementById("launchcalcul").disabled = false;
			};
			var sauv = 0;
			var binary = 0;
			function Lancer(i){
				let debut = performance.now();
				document.getElementById("tvaleurs").innerHTML="Valeurs en temps réel:";
				document.getElementById("launchbutton").disabled = true;
				document.getElementById("launchcalcul").disabled = true;
				document.getElementById("arret").disabled = false;
				document.getElementById("grdarret").disabled = false;
				binary = 0;
				dessin = setInterval(draw,d*1000*ralenti);
				function draw(){
					if(i < listex.length-1){
					document.getElementById("xf").innerHTML="Position x: "+listex[i]+" [m]";
					document.getElementById("yf").innerHTML="Position y: "+listey[i]+" [m]";
					document.getElementById("dnr").innerHTML="Pas n°"+(i+1);
					document.getElementById("vf").innerHTML="Vitesse: "+listev[i]+" [m/s]";
					document.getElementById("inclf").innerHTML="Inclinaison: "+listeincl[i]+" [°]";
					document.getElementById("tr").innerHTML = "Temps: "+((i+1)*d)+ " [s]";
					}else{
					document.getElementById("yf").innerHTML="Position y: 0.000 [m]";
					};
					function retrace(b,a){
						candraw.beginPath();
						for(let k=b;k<a;k++){
							candraw.moveTo(px(listex[k],c),py(listey[k],c))
							candraw.lineTo(px(listex[k+1],c),py(listey[k+1],c))};
						candraw.strokeStyle = "blue";
						candraw.stroke();
					};
					candraw.beginPath();
					candraw.arc(px(listex[i],c),py(listey[i],c),r*c+0.64,0,2*pi);
					candraw.fillStyle = "white";
					candraw.fill();
					var deltax = (listex[i]-listex[i-1]);
					var deltay = (listey[i]-listey[i-1]);
					if((deltax**2+deltay**2)**0.5<r){
						let a = 1;
						while((deltax**2+deltay**2)**0.5<r){
							if(a>i){
								break
							};
							deltax=listex[i]-listex[i-a];
							deltay=listey[i]-listey[i-a];
							a+=1;};
						retrace(i-a,i+1);}else{retrace(i-1,i+1);};
					candraw.beginPath();
					candraw.arc(px(listex[i+1],c),py(listey[i+1],c),r*c,0,2*pi);
					candraw.fillStyle = "black";
					candraw.fill();
					sauv = i;
					//retrace(i,i+1);
					i += 1;
					if(i > listex.length-1){
						clearInterval(dessin);
						let fin = performance.now();
						console.log("Temps d'exécution: "+((fin-debut)/1000-d*ralenti)+" [s]")
						document.getElementById("launchcalcul").disabled = false;
						document.getElementById("launchbutton").disabled = false;
						document.getElementById("arret").disabled = true;
						document.getElementById("grdarret").disabled = true;
						binary = 0;
						document.getElementById("arret").innerHTML="Stop";
					};
				};
			};
			function Stop(){
				if(binary==0){
					document.getElementById("arret").innerHTML="Continue";
					binary=1;
					clearInterval(dessin);
				}else if(binary==1){
					document.getElementById("arret").innerHTML="Stop";
					binary=0;
					Lancer(sauv);
				};
			};
			function Vider(){
				candraw.clearRect(0,0,can.width,can.height);
				xmax = 0;
				ymax = 0;
				clearInterval(dessin);
				document.getElementById("launchcalcul").disabled = false;
				document.getElementById("launchbutton").disabled = false;
			};
			function BigStop(){
				clearInterval(dessin);
				document.getElementById("grdarret").disabled = true;
				document.getElementById("launchcalcul").disabled = false;
				document.getElementById("launchbutton").disabled = false;
				document.getElementById("arret").disabled = true;
				binary = 0;
				document.getElementById("arret").innerHTML="Stop";
			};
		</script>
	</body>
</html>
